# Local Vitess Cluster

This directory contains example scripts to bring up a Vitess cluster on your
local machine, which may be useful for experimentation. These scripts can
also serve as a starting point for configuring Vitess into your preferred
deployment strategy or toolset.

## Requirements

You should have completed a successful `make build` after following the
[Getting Started](https://github.com/youtube/vitess/blob/master/doc/GettingStarted.md)
guide.

## Configuration

Before starting, set `VTROOT` to the base of the Vitess tree that you built.
For example, if you ran `make build` while in
`$HOME/vt/src/github.com/youtube/vitess`, then you should set:
`export VTROOT=$HOME/vt`

Also set `VTDATAROOT` to the directory where you want data files and logs to
be stored. For example: `export VTDATAROOT=$HOME/vtdataroot`

Alternatively, if you are testing on the same machine you just used for
building, you can source `dev.env` as described the Getting Started guide.

## Starting ZooKeeper

The way servers in a Vitess cluster find each other is by looking for dynamic
configuration stored in a distributed lock service. For this example, we will
use ZooKeeper. The following script creates a small ZooKeeper cluster.

```
vitess/examples/local$ ./zk-up.sh
Starting zk servers...
Waiting for zk servers to be ready...
```

Once we have a ZooKeeper cluster, we only need to tell each Vitess process how
to connect to ZooKeeper. Then they can find all the other Vitess processes
by coordinating via ZooKeeper. The way we tell them how to find ZooKeeper is by
setting the `ZK_CLIENT_CONFIG` environment variable to the path to the file
`zk-client-conf.json`, which contains ZK server addresses for each cell.

## Starting vtctld

The vtctld server provides a web interface to view all the coordination
information stored in ZooKeeper.

```
vitess/examples/local$ ./vtctld-up.sh
Starting vtctld...
Access vtctld at http://localhost:15000
```

There won't be anything there yet, but the menu should come up,
verifying that vtctld is running.

## Issuing commands with vtctlclient

The vtctld server also accepts commands from the vtctlclient tool,
which is used to administer the cluster.

```
# list available commands
vitess/examples/local$ $VTTOP/bin/vtctlclient -server localhost:15000
```

## Starting vttablets

For this example, we will bring up 3 tablets.

```
vitess/examples/local$ ./vttablet-up.sh
Starting MySQL for tablet test-0000000100...
Starting vttablet for test-0000000100...
Access tablet test-0000000100 at http://localhost:15100/debug/status
Starting MySQL for tablet test-0000000101...
Starting vttablet for test-0000000101...
Access tablet test-0000000101 at http://localhost:15101/debug/status
Starting MySQL for tablet test-0000000102...
Starting vttablet for test-0000000102...
Access tablet test-0000000102 at http://localhost:15102/debug/status
```

Once they are up, go back to the vtctld web page and click on the
*DbTopology Tool*. You should see all three tablets listed. If you client the
address of one of the tablets, you'll see the coordination data stored in
ZooKeeper. At the top of that page, there is also `[status]` link, which takes
you to the debug page generated by the tablet itself.

By bringing up tablets into a previously empty keyspace, we effectively just
created a new shard. To initialize the keyspace for the new shard, we need to
perform a keyspace rebuild:

```
$ $VTROOT/bin/vtctlclient -server localhost:15000 RebuildKeyspaceGraph test_keyspace
```

Note that most vtctlclient commands produce no output on success.

## Electing a master vttablet

The vttablets have all been started as replicas, but there is no master yet.
When we pick a master vttablet, Vitess will also take care of connecting the
other replicas' mysqld instances to start replicating from the master mysqld.

Since this is the first time we're starting up the shard, there is no existing
replication happening, so we use the -force flag on ReparentShard to skip the
usual validation of each tablet's replication state.

```
$ $VTROOT/bin/vtctlclient -server localhost:15000 ReparentShard -force test_keyspace/0 test-0000000100
```

Once this is done, you should see one master and two replicas in vtctld's web
interface. You can also check this on the command line with vtctlclient:

```
$ $VTROOT/bin/vtctlclient -server localhost:15000 ListAllTablets test
test-0000000100 test_keyspace 0 master localhost:15100 localhost:33100 []
test-0000000101 test_keyspace 0 replica localhost:15101 localhost:33101 []
test-0000000102 test_keyspace 0 replica localhost:15102 localhost:33102 []
```

## Creating a table

The vtctl tool can manage schema across all tablets in a keyspace.
To create the table defined in `create_test_table.sql`:

```
vitess/examples/local$ $VTROOT/bin/vtctlclient -server localhost:15000 ApplySchemaKeyspace -simple -sql "$(cat create_test_table.sql)" test_keyspace
```

# Starting vtgate

Clients send queries to Vitess through vtgate, which routes them to the
correct vttablet behind the scenes. In a real deployment, you would likely
run multiple vtgate instances to share the load. For this local example,
we only need one.

```
vitess/examples/local$ ./vtgate-up.sh
```

## Creating a client app

The file `client.py` contains a simple example app that connects to vtgate
and executes some queries. To run it, you need to add the Vitess Python
packages to your `PYTHONPATH`. Or you can use the wrapper script `client.sh`
that temporarily sets up the environment and then runs `client.py`.

```
vitess/examples/local$ ./client.sh --server=localhost:15001
Inserting into master...
Reading from master...
(1L, 'V is for speed')
Reading from replica...
(1L, 'V is for speed')
```

## Tearing down the cluster

Assuming your `VTDATAROOT` directory is something that you use just for this,
you can kill all the processes we've started like this:

```
# look for processes we started
$ pgrep -u $USER -f -l $VTDATAROOT

# if that list looks right, then kill them
$ pkill -u $USER -f $VTDATAROOT
```

To start over, you should also clear out the contents of `VTDATAROOT`:

```
$ cd $VTDATAROOT
/home/user/vt/vtdataroot$ rm -rf *
```

## Troubleshooting

If anything goes wrong, check the logs in your `$VTDATAROOT/tmp` directory
for error messages. There are also some tablet-specific logs, as well as
MySQL logs in the various `$VTDATAROOT/vt_*` directories.

If you need help diagnosing a problem, send a message to our
[mailing list](https://groups.google.com/forum/#!forum/vitess).
In addition to any errors you see at the command-line, it would also help to
upload an archive of your `$VTDATAROOT` directory to a file sharing service
and provide a link to it.
